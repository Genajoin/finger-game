<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ü–æ–∫–∞–∂–∏ —Ü–∏—Ñ—Ä—É! ‚úã</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Comic Sans MS', sans-serif;
      background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    h1 {
      color: white;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      margin-top: 15px;
      font-size: 2rem;
      text-align: center;
    }

    .game-container {
      display: flex;
      gap: 20px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: center;
      padding: 20px;
    }

    #video-container {
      position: relative;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
      background: white;
    }

    video {
      width: 640px;
      height: 480px;
      object-fit: cover;
      transform: scaleX(-1); /* –∑–µ—Ä–∫–∞–ª—å–Ω–æ–µ –æ—Ç—Ä–∞–∂–µ–Ω–∏–µ –≤–∏–¥–µ–æ */
    }

    #canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    .info-panel {
      background: white;
      padding: 25px;
      border-radius: 20px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.2);
      text-align: center;
      max-width: 350px;
    }

    .target {
      font-size: 5rem;
      color: #ff7f50;
      margin: 20px 0;
      font-weight: bold;
      animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .feedback {
      font-size: 1.4rem;
      margin-top: 15px;
      min-height: 2em;
      color: #2c3e50;
      font-weight: bold;
    }

    .success { color: #2ecc71; }
    .error { color: #e74c3c; }

    @keyframes popIn {
      from { transform: scale(0); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    button.start-btn {
      margin-top: 20px;
      padding: 15px 30px;
      font-size: 1.2rem;
      border: none;
      background-color: #6c5ce7;
      color: white;
      border-radius: 50px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    button.start-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 18px rgba(108,92,231,0.4);
    }

    button.pause-btn {
      margin-top: 10px;
      padding: 12px 25px;
      font-size: 1rem;
      border: none;
      background-color: #f39c12;
      color: white;
      border-radius: 50px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    button.pause-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 18px rgba(243,156,18,0.4);
    }

    button.pause-btn.paused {
      background-color: #e74c3c;
    }

    /* –¢–∞–π–º–µ—Ä –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á—ë—Ç–∞ */
    .timer-bar {
      width: 100%;
      height: 8px;
      background: #ecf0f1;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 15px;
    }

    .timer-progress {
      height: 100%;
      background: linear-gradient(90deg, #2ecc71, #f39c12, #e74c3c);
      width: 100%;
      transition: width 0.1s linear;
      border-radius: 4px;
    }

    /* –°—á—ë—Ç—á–∏–∫ –æ—á–∫–æ–≤ */
    .score-board {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 15px;
      border-radius: 15px;
      margin-bottom: 15px;
      text-align: center;
      color: white;
    }

    .score-board .score {
      font-size: 2rem;
      font-weight: bold;
    }

    .score-board .label {
      font-size: 0.9rem;
      opacity: 0.9;
    }
  </style>
</head>
<body>

<h1>–ü–æ–∫–∞–∂–∏ —Ü–∏—Ñ—Ä—É! ‚úã</h1>

<div class="game-container">
  <div id="video-container">
    <video id="webcam" autoplay playsinline muted></video>
    <canvas id="canvas"></canvas>
  </div>

  <div class="info-panel">
    <div class="score-board">
      <div class="score" id="score">0</div>
      <div class="label">–û—á–∫–æ–≤</div>
    </div>
    <p>–ü–æ–∫–∞–∂–∏ –Ω–∞ –ø–∞–ª—å—Ü–∞—Ö:</p>
    <div class="target" id="targetNum">?</div>
    <div class="timer-bar">
      <div class="timer-progress" id="timerProgress"></div>
    </div>
    <div class="feedback" id="feedbackText">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div id="loadingIndicator" style="font-size: 0.8rem; color: #7f8c8d; margin-top: 10px;">–ó–∞–≥—Ä—É–∑–∫–∞ MediaPipe...</div>
    <button class="start-btn" id="startBtn" onclick="toggleGame()" disabled>‚ñ∂ –°—Ç–∞—Ä—Ç</button>
    <button class="pause-btn" id="pauseBtn" onclick="togglePause()" style="display: none;">‚è∏ –ü–∞—É–∑–∞</button>
  </div>
</div>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º MediaPipe - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞–±–æ—Ç–∞—é—â–∏–µ –≤–µ—Ä—Å–∏–∏ CDN -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

<script>
  // --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–≥—Ä—ã ---
  const MAX_FINGERS = 10; // –î–ª—è –¥–≤—É—Ö —Ä—É–∫ (–ø–æ 5 –ø–∞–ª—å—Ü–µ–≤ –Ω–∞ –∫–∞–∂–¥—É—é)
  const TARGET_DURATION = 8000; // 8 —Å–µ–∫—É–Ω–¥ –Ω–∞ –∑–∞–¥–∞–Ω–∏–µ (–µ—Å–ª–∏ –Ω–µ —É–≥–∞–¥–∞–ª)
  const CORRECT_DELAY = 2000; // 2 —Å–µ–∫—É–Ω–¥—ã –ø–æ–∫–∞–∑–∞ "–ø—Ä–∞–≤–∏–ª—å–Ω–æ" –ø–µ—Ä–µ–¥ –∑–∞–¥–µ—Ä–∂–∫–æ–π
  const BETWEEN_TASKS_DELAY = 1500; // 1.5 —Å–µ–∫—É–Ω–¥—ã –∑–∞–¥–µ—Ä–∂–∫–∏ –º–µ–∂–¥—É –∑–∞–¥–∞–Ω–∏—è–º–∏
  const CONSENSUS_FRAMES = 14; // —Å–∫–æ–ª—å–∫–æ –∫–∞–¥—Ä–æ–≤ –ø–æ–º–Ω–∏—Ç—å (~400-500ms)
  const CONSENSUS_THRESHOLD = 0.8; // 80% —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
  let currentTarget = -1;
  let gameActive = false;
  let gamePaused = false;
  let lastTimeCorrect = 0;
  let stateStartTime = 0;
  let gameMode = "ask"; // "ask" (–∑–∞–¥–∞–Ω–∏–µ), "correct" (–ø—Ä–∞–≤–∏–ª—å–Ω–æ), "timeout" (–≤—Ä–µ–º—è –≤—ã—à–ª–æ), "delay" (–∑–∞–¥–µ—Ä–∂–∫–∞)
  let score = 0;
  let pauseTimeRemaining = 0; // –î–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Å—Ç–∞–≤—à–µ–≥–æ—Å—è –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏ –ø–∞—É–∑–µ

  // –ë—É—Ñ–µ—Ä –¥–ª—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–Ω—Å–µ–Ω—Å—É—Å–æ–º
  let consensusBuffer = []; // –∫–æ–ª—å—Ü–µ–≤–æ–π –±—É—Ñ–µ—Ä –ø–æ—Å–ª–µ–¥–Ω–∏—Ö N –∑–Ω–∞—á–µ–Ω–∏–π
  let processingCorrect = false; // —Ñ–ª–∞–≥ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
  let displayCount = null; // –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è

  // DOM-—ç–ª–µ–º–µ–Ω—Ç—ã
  const videoElement = document.getElementById('webcam');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const targetEl = document.getElementById('targetNum');
  const feedbackEl = document.getElementById('feedbackText');
  const startBtn = document.getElementById('startBtn');
  const pauseBtn = document.getElementById('pauseBtn');
  const scoreEl = document.getElementById('score');
  const timerProgressEl = document.getElementById('timerProgress');
  const loadingIndicator = document.getElementById('loadingIndicator');

  let hands;
  let camera;

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è MediaPipe
  async function setupMediaPipe() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å –ª–∏ —Å–∫—Ä–∏–ø—Ç—ã MediaPipe
    if (typeof Hands === 'undefined') {
      throw new Error('MediaPipe Hands –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');
    }
    if (typeof Camera === 'undefined') {
      throw new Error('MediaPipe Camera –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');
    }
    if (typeof drawConnectors === 'undefined') {
      throw new Error('MediaPipe Drawing utils –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω.');
    }

    hands = new Hands({
      locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
    });

    hands.setOptions({
      maxNumHands: 2, // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–≤—É—Ö —Ä—É–∫
      modelComplexity: 0, // –ª–µ–≥–∫–æ–≤–µ—Å–Ω–∞—è –º–æ–¥–µ–ª—å
      minDetectionConfidence: 0.7,
      minTrackingConfidence: 0.5
    });

    hands.onResults((results) => {
      if (!gameActive || gamePaused) return;
      processFrame(results);
    });

    camera = new Camera(videoElement, {
      onFrame: async () => await hands.send({image: videoElement}),
      width: 640,
      height: 480
    });
  }

  // –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–∞–ª—å—Ü–µ–≤ (—Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –¥–≤—É—Ö —Ä—É–∫)
  function countFingers(landmarksList) {
    let totalCount = 0;

    for (const landmarks of landmarksList) {
      const tips = [8, 12, 16, 20]; // –ö–æ–Ω—á–∏–∫–∏ —É–∫–∞–∑–∞—Ç–µ–ª—å–Ω–æ–≥–æ, —Å—Ä–µ–¥–Ω–µ–≥–æ, –±–µ–∑—ã–º—è–Ω–Ω–æ–≥–æ, –º–∏–∑–∏–Ω—Ü–∞
      const pips = [6, 10, 14, 18]; // –°—Ä–µ–¥–Ω–∏–µ —Å—É—Å—Ç–∞–≤—ã (PIP)
      const thumbTip = 4;
      const thumbIP = 3;
      const thumbMCP = 2;
      const wrist = landmarks[0];
      const indexMCP = landmarks[5];
      const pinkyMCP = landmarks[17];

      let count = 0;

      // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
      function dist(p1, p2) {
        return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));
      }

      // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —É–≥–ª–∞ –º–µ–∂–¥—É —Ç—Ä–µ–º—è —Ç–æ—á–∫–∞–º–∏ (–≤ –≥—Ä–∞–¥—É—Å–∞—Ö)
      function angle(a, b, c) {
        const ab = { x: b.x - a.x, y: b.y - a.y };
        const cb = { x: b.x - c.x, y: b.y - c.y };
        const dot = ab.x * cb.x + ab.y * cb.y;
        const magAB = Math.sqrt(ab.x * ab.x + ab.y * ab.y);
        const magCB = Math.sqrt(cb.x * cb.x + cb.y * cb.y);
        if (magAB === 0 || magCB === 0) return 0;
        const cosAngle = Math.max(-1, Math.min(1, dot / (magAB * magCB)));
        return Math.acos(cosAngle) * (180 / Math.PI);
      }

      // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º 4 –ø–∞–ª—å—Ü–∞ (—É–∫–∞–∑–∞—Ç–µ–ª—å–Ω—ã–π, —Å—Ä–µ–¥–Ω–∏–π, –±–µ–∑—ã–º—è–Ω–Ω—ã–π, –º–∏–∑–∏–Ω–µ—Ü)
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–º–±–∏–Ω–∞—Ü–∏—é: —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç MCP + —É–≥–æ–ª —Å–≥–∏–±–∞
      const mcps = [5, 9, 13, 17]; // MCP —Å—É—Å—Ç–∞–≤—ã (–æ—Å–Ω–æ–≤–∞–Ω–∏—è –ø–∞–ª—å—Ü–µ–≤)

      for (let i = 0; i < tips.length; i++) {
        const tip = landmarks[tips[i]];
        const pip = landmarks[pips[i]];
        const mcp = landmarks[mcps[i]];
        const dip = landmarks[tips[i] - 1]; // DIP —Å—É—Å—Ç–∞–≤ (–º–µ–∂–¥—É PIP –∏ tip)

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –∫–æ–Ω—á–∏–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–∞–ª—å—à–µ –æ—Ç MCP —á–µ–º PIP
        const distTipToMCP = dist(tip, mcp);
        const distPipToMCP = dist(pip, mcp);
        const extendedRatio = distTipToMCP / distPipToMCP;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: —É–≥–æ–ª —Å–≥–∏–±–∞ –≤ PIP –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ—á—Ç–∏ –ø—Ä—è–º—ã–º (>140¬∞)
        const pipAngle = angle(tip, pip, mcp);

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç –∑–∞–ø—è—Å—Ç—å—è
        const distTipToWrist = dist(tip, wrist);
        const distMcpToWrist = dist(mcp, wrist);
        const reachRatio = distTipToWrist / distMcpToWrist;

        // –ü–∞–ª–µ—Ü —Ä–∞–∑–æ–≥–Ω—É—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –í–°–ï —É—Å–ª–æ–≤–∏—è (—Ç–æ–Ω–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞)
        if (extendedRatio > 1.2 && pipAngle > 115 && reachRatio > 1.3) {
          count++;
        }
      }

      // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–æ–ª—å—à–æ–π –ø–∞–ª–µ—Ü
      const thumbTipPos = landmarks[thumbTip];
      const thumbIPPos = landmarks[thumbIP];
      const thumbMCPPos = landmarks[thumbMCP];

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: —É–≥–æ–ª –≤ —Å—É—Å—Ç–∞–≤–µ –±–æ–ª—å—à–æ–≥–æ –ø–∞–ª—å—Ü–∞ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–∞–∑–æ–≥–Ω—É—Ç)
      const thumbAngle = angle(thumbTipPos, thumbIPPos, thumbMCPPos);

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç –∫–æ–Ω—á–∏–∫–∞ –¥–æ –∑–∞–ø—è—Å—Ç—å—è
      const thumbTipToWrist = dist(thumbTipPos, wrist);
      const thumbBaseToWrist = dist(thumbMCPPos, wrist);

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: –±–æ–ª—å—à–æ–π –ø–∞–ª–µ—Ü –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–æ–≥–Ω—É—Ç –≤–Ω—É—Ç—Ä—å
      const thumbIPToWrist = dist(thumbIPPos, wrist);

      // –ë–æ–ª—å—à–æ–π –ø–∞–ª–µ—Ü —Ä–∞–∑–æ–≥–Ω—É—Ç –µ—Å–ª–∏:
      // - —É–≥–æ–ª > 140¬∞ (–ø—Ä—è–º–æ–π)
      // - –∫–æ–Ω—á–∏–∫ –¥–∞–ª–µ–∫–æ –æ—Ç –∑–∞–ø—è—Å—Ç—å—è (>90% –¥–ª–∏–Ω—ã –æ—Ç –æ—Å–Ω–æ–≤–∞–Ω–∏—è –¥–æ –∑–∞–ø—è—Å—Ç—å—è)
      // - –∫–æ–Ω—á–∏–∫ –¥–∞–ª—å—à–µ –æ—Ç –∑–∞–ø—è—Å—Ç—å—è —á–µ–º IP (–Ω–µ —Å–æ–≥–Ω—É—Ç –≤–Ω—É—Ç—Ä—å)
      if (thumbAngle > 140 && thumbTipToWrist > thumbBaseToWrist * 0.9 &&
          thumbTipToWrist > thumbIPToWrist) {
        count += 1;
      }

      totalCount += count;
    }

    return Math.min(totalCount, MAX_FINGERS);
  }

  // –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∫–æ–Ω—Å–µ–Ω—Å—É—Å –±—É—Ñ–µ—Ä–∞
  function getConsensusValue(rawCount) {
    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –±—É—Ñ–µ—Ä
    consensusBuffer.push(rawCount);

    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –±—É—Ñ–µ—Ä–∞
    if (consensusBuffer.length > CONSENSUS_FRAMES) {
      consensusBuffer.shift();
    }

    // –ï—Å–ª–∏ –±—É—Ñ–µ—Ä –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–∞–ø–æ–ª–Ω–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º null (–Ω–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è)
    if (consensusBuffer.length < CONSENSUS_FRAMES * 0.5) {
      return null;
    }

    // –°—á–∏—Ç–∞–µ–º —á–∞—Å—Ç–æ—Ç—É –∫–∞–∂–¥–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
    const frequency = {};
    for (const value of consensusBuffer) {
      frequency[value] = (frequency[value] || 0) + 1;
    }

    // –ù–∞—Ö–æ–¥–∏–º –∑–Ω–∞—á–µ–Ω–∏–µ —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —á–∞—Å—Ç–æ—Ç–æ–π
    let maxCount = 0;
    let consensusValue = null;
    for (const [value, count] of Object.entries(frequency)) {
      if (count > maxCount) {
        maxCount = count;
        consensusValue = parseInt(value);
      }
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä–æ–≥ –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞
    const consensusRatio = maxCount / consensusBuffer.length;
    if (consensusRatio >= CONSENSUS_THRESHOLD) {
      return consensusValue;
    }

    return null; // –ù–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞
  }

  function processFrame(results) {
    // üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û—á–∏—â–∞–µ–º –∫–∞–Ω–≤–∞—Å –ø–µ—Ä–µ–¥ –æ—Ç—Ä–∏—Å–æ–≤–∫–æ–π
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    const landmarksList = results.multiHandLandmarks;

    if (!landmarksList || landmarksList.length === 0) {
      // –û—á–∏—â–∞–µ–º –±—É—Ñ–µ—Ä –µ—Å–ª–∏ —Ä—É–∫ –Ω–µ—Ç
      consensusBuffer = [];
      feedbackEl.textContent = "–ü–æ–∫–∞–∂–∏ –Ω–∞ –ø–∞–ª—å—Ü–∞—Ö!";
      feedbackEl.className = "feedback";
      return;
    }

    // –†–∏—Å—É–µ–º –≤—Å–µ —Ä—É–∫–∏
    for (const landmarks of landmarksList) {
      // üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ó–µ—Ä–∫–∞–ª–∏–º —Ä–∏—Å–æ–≤–∞–Ω–∏–µ —Å–∫–µ–ª–µ—Ç–∞ (–Ω–æ –Ω–µ –≤–∏–¥–µ–æ!)
      ctx.save(); 
      ctx.translate(canvas.width / 2, canvas.height / 2);
      ctx.scale(-1, 1); 
      ctx.translate(-canvas.width / 2, -canvas.height / 2);

      // –†–∏—Å—É–µ–º —Ä—É–∫—É
      drawConnectors(ctx, landmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 2});
      drawLandmarks(ctx, landmarks, {color: '#FF0000', lineWidth: 1, radius: 2});

      ctx.restore(); // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    }

    const rawFingerCount = countFingers(landmarksList);
    const stableCount = getConsensusValue(rawFingerCount);

    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ–º –∑–Ω–∞—á–µ–Ω–∏–∏ (–ø–ª–∞–≤–Ω–æ—Å—Ç—å)
    if (stableCount !== null) {
      displayCount = stableCount;
    }
    // –ï—Å–ª–∏ –Ω–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "..." –∏–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ–µ
    const displayText = displayCount !== null ? displayCount : "...";
    feedbackEl.textContent = `–í–∏–∂—É ${displayText} –ø–∞–ª—å—Ü–∞(–æ–≤)`;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏ –º—ã –≤ —Ä–µ–∂–∏–º–µ "ask"
    if (gameMode === "ask" && !processingCorrect && stableCount !== null && currentTarget !== -1 && stableCount === currentTarget) {
      handleCorrect(stableCount);
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–π–º–∞—É—Ç–∞ –∑–∞–¥–∞–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞
    if (gameMode === "ask") {
      const now = Date.now();
      const elapsed = now - stateStartTime;
      const remaining = Math.max(0, TARGET_DURATION - elapsed);
      const progress = (remaining / TARGET_DURATION) * 100;
      timerProgressEl.style.width = progress + '%';

      // –ú–µ–Ω—è–µ–º —Ü–≤–µ—Ç —Ç–∞–π–º–µ—Ä–∞ –ø—Ä–∏ –º–∞–ª–æ–º –≤—Ä–µ–º–µ–Ω–∏
      if (progress < 30) {
        timerProgressEl.style.background = '#e74c3c';
      } else if (progress < 60) {
        timerProgressEl.style.background = '#f39c12';
      } else {
        timerProgressEl.style.background = 'linear-gradient(90deg, #2ecc71, #f39c12, #e74c3c)';
      }

      if (elapsed > TARGET_DURATION) {
        gameMode = "timeout";
        feedbackEl.textContent = "–í—Ä–µ–º—è –≤—ã—à–ª–æ! –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.";
        feedbackEl.className = "feedback error";
        timerProgressEl.style.width = '0%';
        setTimeout(() => {
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º –∑–∞–¥–∞–Ω–∏–µ–º
          gameMode = "delay";
          targetEl.textContent = "...";
          feedbackEl.textContent = "–ì–æ—Ç–æ–≤—å—Å—è –∫ —Å–ª–µ–¥—É—é—â–µ–º—É...";
          feedbackEl.className = "feedback";
          setTimeout(() => {
            nextTarget();
          }, BETWEEN_TASKS_DELAY);
        }, 2000);
      }
    } else {
      // –°–∫—Ä—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –µ—Å–ª–∏ –Ω–µ –≤ —Ä–µ–∂–∏–º–µ –∑–∞–¥–∞–Ω–∏—è
      timerProgressEl.style.width = gameMode === "delay" ? '100%' : '0%';
    }
  }

  function handleCorrect(count) {
    // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É
    processingCorrect = true;
    lastTimeCorrect = Date.now();

    gameMode = "correct";
    feedbackEl.textContent = "–ú–æ–ª–æ–¥–µ—Ü! –ü—Ä–∞–≤–∏–ª—å–Ω–æ! üéâ";
    feedbackEl.className = "feedback success";
    playSound(true);

    // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á—ë—Ç
    score += 10;
    scoreEl.textContent = score;

    setTimeout(() => {
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º –∑–∞–¥–∞–Ω–∏–µ–º
      gameMode = "delay";
      targetEl.textContent = "...";
      feedbackEl.textContent = "–ì–æ—Ç–æ–≤—å—Å—è –∫ —Å–ª–µ–¥—É—é—â–µ–º—É...";
      feedbackEl.className = "feedback";

      setTimeout(() => {
        nextTarget();
      }, BETWEEN_TASKS_DELAY);
    }, CORRECT_DELAY);
  }

  function nextTarget() {
    currentTarget = Math.floor(Math.random() * (MAX_FINGERS + 1)); // 0..10
    targetEl.textContent = currentTarget;
    feedbackEl.textContent = "–ü–æ–∫–∞–∂–∏ –Ω–∞ –ø–∞–ª—å—Ü–∞—Ö!";
    feedbackEl.className = "feedback";
    gameMode = "ask";
    stateStartTime = Date.now();

    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä
    timerProgressEl.style.width = '100%';
    timerProgressEl.style.background = 'linear-gradient(90deg, #2ecc71, #f39c12, #e74c3c)';

    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –±—É—Ñ–µ—Ä –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞ –∏ —Ñ–ª–∞–≥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–ª—è –Ω–æ–≤–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è
    consensusBuffer = [];
    processingCorrect = false;
    displayCount = null;

    targetEl.style.animation = 'none';
    void targetEl.offsetHeight;
    targetEl.style.animation = 'popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
  }

  // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∏–≥—Ä—ã (—Å—Ç–∞—Ä—Ç/—Å—Ç–æ–ø)
  function toggleGame() {
    if (gameActive) {
      stopGame();
    } else {
      startGame();
    }
  }

  // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏–≥—Ä—ã
  function stopGame() {
    gameActive = false;
    gamePaused = false;
    startBtn.textContent = "‚ñ∂ –°—Ç–∞—Ä—Ç";
    pauseBtn.style.display = "none";
    targetEl.textContent = "?";
    feedbackEl.textContent = "–ù–∞–∂–º–∏ ¬´–°—Ç–∞—Ä—Ç¬ª, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å!";
    feedbackEl.className = "feedback";
    timerProgressEl.style.width = '0%';
    score = 0;
    scoreEl.textContent = score;

    if (camera) {
      camera.stop();
    }
  }

  // –ü–∞—É–∑–∞/–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ
  function togglePause() {
    gamePaused = !gamePaused;

    if (gamePaused) {
      pauseBtn.textContent = "‚ñ∂ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å";
      pauseBtn.classList.add("paused");
      feedbackEl.textContent = "–ò–≥—Ä–∞ –Ω–∞ –ø–∞—É–∑–µ";
      feedbackEl.className = "feedback";
    } else {
      pauseBtn.textContent = "‚è∏ –ü–∞—É–∑–∞";
      pauseBtn.classList.remove("paused");
      feedbackEl.textContent = "–ü–æ–∫–∞–∂–∏ –Ω–∞ –ø–∞–ª—å—Ü–∞—Ö!";
      feedbackEl.className = "feedback";
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –∑–∞–¥–∞–Ω–∏—è —á—Ç–æ–±—ã –∫–æ–º–ø–µ–Ω—Å–∏—Ä–æ–≤–∞—Ç—å –ø–∞—É–∑—É
      stateStartTime = Date.now();
    }
  }

  function playSound(isSuccess) {
    try {
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      if (!AudioContext) return;
      const ctx = new AudioContext();
      const osc = ctx.createOscillator();
      const gainNode = ctx.createGain();

      osc.connect(gainNode);
      gainNode.connect(ctx.destination);

      if (isSuccess) {
        osc.type = 'sine';
        osc.frequency.setValueAtTime(880, ctx.currentTime); 
        osc.frequency.exponentialRampToValueAtTime(1760, ctx.currentTime + 0.2);
        gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
        osc.start();
        osc.stop(ctx.currentTime + 0.5);
      }
    } catch (e) {
      console.warn("AudioContext not available or blocked");
    }
  }

  async function startGame() {
    if (gameActive) return;

    console.log("Starting game...");
    feedbackEl.textContent = "–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ...";

    try {
      console.log("Setting up MediaPipe...");
      await setupMediaPipe();
      console.log("Starting camera...");
      await camera.start();
      console.log("Camera started!");
      gameActive = true;
      gamePaused = false;
      score = 0;
      scoreEl.textContent = score;
      startBtn.textContent = "‚èπ –°—Ç–æ–ø";
      pauseBtn.style.display = "inline-block";
      pauseBtn.textContent = "‚è∏ –ü–∞—É–∑–∞";
      pauseBtn.classList.remove("paused");
      nextTarget();
      feedbackEl.textContent = "–ü–æ–∫–∞–∂–∏ –Ω–∞ –ø–∞–ª—å—Ü–∞—Ö!";
      feedbackEl.className = "feedback";
    } catch (err) {
      console.error("Error starting game:", err);
      feedbackEl.textContent = "–û—à–∏–±–∫–∞: " + err.message;
      feedbackEl.className = "feedback error";
    }
  }

  // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–æ–≤
  window.onload = async () => {
    console.log("Page loaded, waiting for MediaPipe...");

    // –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–æ–≤ MediaPipe
    let attempts = 0;
    const maxAttempts = 100; // 10 —Å–µ–∫—É–Ω–¥ –º–∞–∫—Å–∏–º—É–º

    const checkLoaded = () => {
      const loaded = typeof Hands !== 'undefined' &&
             typeof Camera !== 'undefined' &&
             typeof drawConnectors !== 'undefined' &&
             typeof drawLandmarks !== 'undefined' &&
             typeof HAND_CONNECTIONS !== 'undefined';
      console.log("Checking MediaPipe:", loaded, {
        Hands: typeof Hands,
        Camera: typeof Camera,
        drawConnectors: typeof drawConnectors,
        HAND_CONNECTIONS: typeof HAND_CONNECTIONS
      });
      return loaded;
    };

    while (!checkLoaded() && attempts < maxAttempts) {
      await new Promise(resolve => setTimeout(resolve, 100));
      attempts++;
      if (attempts % 10 === 0) {
        loadingIndicator.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞ MediaPipe... (${attempts/10}s)`;
      }
    }

    if (!checkLoaded()) {
      console.error("MediaPipe scripts failed to load");
      loadingIndicator.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.";
      feedbackEl.textContent = "–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å MediaPipe";
      feedbackEl.className = "feedback error";
      startBtn.disabled = true;
      return;
    }

    loadingIndicator.style.display = "none";
    startBtn.disabled = false;
    feedbackEl.textContent = "–ù–∞–∂–º–∏ ¬´–°—Ç–∞—Ä—Ç¬ª, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å!";

    try {
      await setupMediaPipe();
      startBtn.textContent = "‚ñ∂ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É";
      console.log("MediaPipe initialized successfully!");
    } catch (e) {
      console.error("Setup failed:", e);
      startBtn.textContent = "‚ñ∂ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É";
    }
  };
</script>
</body>
</html>
